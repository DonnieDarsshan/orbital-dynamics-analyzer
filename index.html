<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Astrology Relation Tool</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  background:#0f172a;
  color:#e5e7eb;
  font-family:Arial,sans-serif;
  padding:20px;
}

/* controls */
select,button,input[type="checkbox"],input[type="radio"],input.note{
  background:#020617;
  color:#e5e7eb;
  border:1px solid #334155;
  padding:4px;
}

/* tables */
table{
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
}
th,td{
  border:1px solid #334155;
  padding:6px;
  text-align:center;
  font-size:14px;
}
th{background:#020617;}
.deg-disabled{opacity:.4;pointer-events:none;}
.gap-row td{border:none;height:12px;}

/* note rows */
.note-row td{background:#020617;}

/* note input */
.note{
  width:100%;
  box-sizing:border-box;
  text-align:center;
  font-size:14px;
}

/* BAD row */
tr.note-row.bad-row td{
  color:#ef4444 !important;
  font-weight:bold !important;
  background:#1a0000 !important;
}
tr.note-row.bad-row .note{
  background:#1a0000 !important;
  color:#ef4444 !important;
  font-weight:bold !important;
  border-color:#7f1d1d !important;
}
.bad-label{
  color:#ef4444 !important;
  font-weight:bold !important;
}
</style>
</head>

<body>

<h2>Planet Positions</h2>

<div>
  <label><input type="checkbox" id="ignoreDegrees"> Ignore Degrees</label>
  <label><input type="radio" name="houseSys" value="KP" checked> KP</label>
  <label><input type="radio" name="houseSys" value="Vedic"> Vedic</label>
  <button id="clearBtn">Clear All</button>
  <button id="saveBtn">Save</button>
  <button id="loadBtn">Load</button>
  <button id="exportPDF">Export PDF</button>
  <button id="exportJPG">Export JPG</button>
  <input type="file" id="fileInput" hidden accept=".json">
</div>

<table>
<thead>
<tr>
  <th>Planet</th><th>Retro</th><th>Sign</th><th>Degree</th><th>Output</th>
</tr>
</thead>
<tbody id="planetTable"></tbody>
</table>

<h2>Planetary Distance Matrix</h2>

<div>
  Lagna:
  <select id="lagnaSelect"></select>
</div>

<table>
<thead>
<tr>
  <th>No</th><th>Lord</th>
  <th>Jup</th><th>Sat</th><th>Bud</th><th>Ket</th>
  <th>Ven</th><th>Sun</th><th>Moo</th><th>Mar</th><th>Rah</th>
</tr>
</thead>
<tbody id="matrixTable"></tbody>
</table>

<script>
const SIGNS=["Aries","Taurus","Gemini","Cancer","Leo","Virgo","Libra","Scorpio","Sagittarius","Capricorn","Aquarius","Pisces"];
const ALL_PLANETS=["Lagna","Sun","Moo","Mar","Rah","Jup","Sat","Bud","Ket","Ven"];
const COL_PLANETS=["Jup","Sat","Bud","Ket","Ven","Sun","Moo","Mar","Rah"];

const data={};
ALL_PLANETS.forEach(p=>data[p]={sign:"",degree:"",out:"",retro:(p==="Rah"||p==="Ket")});

let notes=[];
let houseSystem="KP";

const LAGNA_LORDS={
Aries:["Mar","Ven","Bud","Moo","Sun","Bud","Ven","Mar","Jup","Sat","Sat","Jup"],
Taurus:["Ven","Bud","Moo","Sun","Bud","Ven","Mar","Jup","Sat","Sat","Jup","Mar"],
Gemini:["Bud","Moo","Sun","Bud","Ven","Mar","Jup","Sat","Sat","Jup","Mar","Ven"],
Cancer:["Moo","Sun","Bud","Ven","Mar","Jup","Sat","Sat","Jup","Mar","Ven","Bud"],
Leo:["Sun","Bud","Ven","Mar","Jup","Sat","Sat","Jup","Mar","Ven","Bud","Moo"],
Virgo:["Bud","Ven","Mar","Jup","Sat","Sat","Jup","Mar","Ven","Bud","Moo","Sun"],
Libra:["Ven","Mar","Jup","Sat","Sat","Jup","Mar","Ven","Bud","Moo","Sun","Bud"],
Scorpio:["Mar","Jup","Sat","Sat","Jup","Mar","Ven","Bud","Moo","Sun","Bud","Ven"],
Sagittarius:["Jup","Sat","Sat","Jup","Mar","Ven","Bud","Moo","Sun","Bud","Ven","Mar"],
Capricorn:["Sat","Sat","Jup","Mar","Ven","Bud","Moo","Sun","Bud","Ven","Mar","Jup"],
Aquarius:["Sat","Jup","Mar","Ven","Bud","Moo","Sun","Bud","Ven","Mar","Jup","Sat"],
Pisces:["Jup","Mar","Ven","Bud","Moo","Sun","Bud","Ven","Mar","Jup","Sat","Sat"]
};

const lagnaSelect=document.getElementById("lagnaSelect");
SIGNS.forEach(s=>lagnaSelect.innerHTML+=`<option>${s}</option>`);

const planetTable=document.getElementById("planetTable");
const matrixTable=document.getElementById("matrixTable");
const ignoreDegreesChk=document.getElementById("ignoreDegrees");
const fileInput=document.getElementById("fileInput");

function absPos(p){
  if(!data[p].sign) return null;
  const deg=ignoreDegreesChk.checked?0:Number(data[p].degree||0);
  return SIGNS.indexOf(data[p].sign)*30+deg;
}

function calcHouse(diff){
  let h=houseSystem==="Vedic"
    ?Math.floor((diff+15)/30)+1
    :Math.floor(diff/30)+1;
  if(h>12) h-=12;
  return h;
}

function recalcOutputs(){
  const lagnaAbs=absPos("Lagna");
  ALL_PLANETS.forEach(p=>{
    data[p].out="";
    if(!data[p].sign||lagnaAbs==null) return;
    let diff=absPos(p)-lagnaAbs;
    if(diff<0) diff+=360;
    data[p].out=calcHouse(diff);
  });
}

function buildPlanetTable(){
  planetTable.innerHTML="";
  ALL_PLANETS.forEach(p=>{
    planetTable.innerHTML+=`
    <tr>
      <td>${p}</td>
      <td>${p==="Lagna"?"":`<input type="checkbox" data-p="${p}" ${data[p].retro?"checked":""}>`}</td>
      <td><select data-p="${p}" data-t="sign"><option></option>${SIGNS.map(s=>`<option>${s}</option>`).join("")}</select></td>
      <td><select data-p="${p}" data-t="deg"><option></option>${Array.from({length:30},(_,i)=>`<option>${i}</option>`).join("")}</select></td>
      <td>${data[p].out||""}</td>
    </tr>`;
  });

  planetTable.querySelectorAll("input[type='checkbox']").forEach(chk=>{
    chk.onchange=()=>{
      data[chk.dataset.p].retro=chk.checked;
      buildMatrix();
    };
  });

  planetTable.querySelectorAll("select").forEach(sel=>{
    const p=sel.dataset.p;
    sel.value=data[p][sel.dataset.t==="sign"?"sign":"degree"];
    if(sel.dataset.t==="deg") sel.classList.toggle("deg-disabled",ignoreDegreesChk.checked);
    sel.onchange=()=>{
      data[p][sel.dataset.t==="sign"?"sign":"degree"]=sel.value;
      recalcOutputs();buildPlanetTable();buildMatrix();
    };
  });
}

function noteRow(isBad=false,rowIndex){
  return `
  <tr class="note-row ${isBad?'bad-row':''}">
    <td class="${isBad?'bad-label':''}">${isBad?'BAD':''}</td>
    <td></td>
    ${COL_PLANETS.map((_,i)=>`
      <td>
        <input class="note ${isBad?'bad-note':''}"
               data-note="${rowIndex}-${i}"
               value="${notes[rowIndex]?.[i]||''}">
      </td>
    `).join("")}
  </tr>`;
}

function collectNotes(){
  notes=[];
  document.querySelectorAll('.note-row').forEach((row,r)=>{
    notes[r]=[];
    row.querySelectorAll('.note').forEach((inp,c)=>{
      notes[r][c]=inp.value;
    });
  });
}

function buildMatrix(){
  matrixTable.innerHTML="";
  matrixTable.innerHTML+=noteRow(false,0);

  const lords=LAGNA_LORDS[lagnaSelect.value];
  lords.forEach((lord,i)=>{
    matrixTable.innerHTML+=`
    <tr>
      <td>${i+1}</td><td>${lord}</td>
      ${COL_PLANETS.map(col=>{
        if(lord===col) return `<td>${data[col].out||""}</td>`;
        const a=absPos(lord),b=absPos(col);
        if(a==null||b==null) return "<td></td>";
        let diff=data[lord].retro?a-b:b-a;
        if(diff<0) diff+=360;
        return `<td>${calcHouse(diff)}</td>`;
      }).join("")}
    </tr>`;
  });

  matrixTable.innerHTML+=`<tr class="gap-row"><td colspan="11"></td></tr>`;

  ["Rah","Ket"].forEach(r=>{
    matrixTable.innerHTML+=`
    <tr>
      <td></td><td>${r}</td>
      ${COL_PLANETS.map(col=>{
        if(r===col) return `<td>${data[col].out||""}</td>`;
        const a=absPos(r),b=absPos(col);
        if(a==null||b==null) return "<td></td>";
        let diff=data[r].retro?a-b:b-a;
        if(diff<0) diff+=360;
        return `<td>${calcHouse(diff)}</td>`;
      }).join("")}
    </tr>`;
  });

  matrixTable.innerHTML+=`<tr class="gap-row"><td colspan="11"></td></tr>`;
  matrixTable.innerHTML+=noteRow(false,1);
  matrixTable.innerHTML+=noteRow(true,2);
}

ignoreDegreesChk.onchange=()=>{recalcOutputs();buildPlanetTable();buildMatrix();};
lagnaSelect.onchange=buildMatrix;
document.querySelectorAll('input[name="houseSys"]').forEach(r=>{
  r.onchange=e=>{
    houseSystem=e.target.value;
    recalcOutputs();buildPlanetTable();buildMatrix();
  };
});

document.getElementById("clearBtn").onclick=()=>{
  if(!confirm("Are you sure you want to clear the entire chart?")) return;
  ALL_PLANETS.forEach(p=>data[p]={sign:"",degree:"",out:"",retro:(p==="Rah"||p==="Ket")});
  notes=[];
  buildPlanetTable();
  matrixTable.innerHTML="";
};

document.getElementById("saveBtn").onclick=()=>{
  collectNotes();
  const blob=new Blob(
    [JSON.stringify({data,lagna:lagnaSelect.value,ignore:ignoreDegreesChk.checked,houseSystem,notes})],
    {type:"application/json"}
  );
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="chart.json";
  a.click();
};

document.getElementById("loadBtn").onclick=()=>{
  fileInput.value="";
  fileInput.click();
};

fileInput.onchange=e=>{
  const r=new FileReader();
  r.onload=()=>{
    const o=JSON.parse(r.result);
    Object.assign(data,o.data);
    notes=o.notes||[];
    lagnaSelect.value=o.lagna;
    ignoreDegreesChk.checked=o.ignore;
    houseSystem=o.houseSystem;
    recalcOutputs();
    buildPlanetTable();
    buildMatrix();
  };
  r.readAsText(e.target.files[0]);
};

buildPlanetTable();
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
document.getElementById("exportJPG").onclick = async () => {
  const canvas = await html2canvas(document.body,{
    backgroundColor:"#0f172a",
    scale:2
  });
  const a=document.createElement("a");
  a.href=canvas.toDataURL("image/jpeg",1.0);
  a.download="astrology-chart.jpg";
  a.click();
};

document.getElementById("exportPDF").onclick = async () => {
  const canvas = await html2canvas(document.body,{
    backgroundColor:"#0f172a",
    scale:2
  });
  const img=canvas.toDataURL("image/jpeg",1.0);
  const { jsPDF } = window.jspdf;
  const pdf=new jsPDF("p","mm","a4");
  const w=pdf.internal.pageSize.getWidth();
  const h=(canvas.height*w)/canvas.width;
  pdf.addImage(img,"JPEG",0,0,w,h);
  pdf.save("astrology-chart.pdf");
};
</script>

</body>
</html>
